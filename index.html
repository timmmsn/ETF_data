<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£é«˜è‚¡æ¯ ETF æœˆé ˜è©¦ç®—èˆ‡æ¯”è¼ƒ (2025 é…æ¯æœˆä»½ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        .refresh-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .price-flash { animation: flash 1s; }
        @keyframes flash { 0% { background-color: #d1fae5; } 100% { background-color: transparent; } }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        th, td { white-space: nowrap; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-700 to-indigo-800 p-6 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold mb-1">ğŸ“Š å°ç£é«˜è‚¡æ¯ ETF æœˆé ˜è–ªæ°´è©¦ç®—</h1>
                <p class="text-blue-200 text-sm opacity-90 flex items-center gap-2">
                    <i class="fas fa-calendar-alt"></i> è³‡æ–™åŸºæº–ï¼šTWSE å³æ™‚è‚¡åƒ¹ x é ä¼°å¹´åŒ–æ®–åˆ©ç‡ (å«é…æ¯æœˆä»½)
                </p>
            </div>
            <button onclick="fetchRealStockPrices()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition backdrop-blur-sm text-sm border border-white/40 shadow-sm">
                <i id="refreshIcon" class="fas fa-sync-alt"></i>
                æ›´æ–°å³æ™‚è‚¡åƒ¹
            </button>
        </div>

        <div class="p-6">
            <!-- Control Panel -->
            <div class="mb-8 bg-blue-50 p-6 rounded-lg border border-blue-100">
                <label for="monthlyTarget" class="block text-lg font-semibold text-gray-700 mb-4">
                    ç›®æ¨™æ¯æœˆå¹³å‡è¢«å‹•æ”¶å…¥ï¼š<span id="targetDisplay" class="text-3xl text-blue-600 font-bold">10,000</span> å…ƒ
                </label>
                <input type="range" id="monthlyTarget" min="10000" max="100000" step="5000" value="10000" 
                       class="w-full h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
                <div class="flex justify-between text-sm text-gray-500 mt-2">
                    <span>1è¬</span>
                    <span>10è¬</span>
                </div>
                <!-- NHI Warning -->
                <div class="mt-4 flex items-start gap-2 text-sm text-orange-800 bg-orange-50 p-3 rounded border border-orange-100">
                    <i class="fas fa-exclamation-triangle mt-1"></i>
                    <p>
                        <strong>äºŒä»£å¥ä¿æé†’ï¼š</strong> å–®æ¬¡è‚¡åˆ©çµ¦ä»˜é” <strong>20,000</strong> å…ƒ(å«)ï¼Œéœ€æ‰£ç¹³ <strong>2.11%</strong> è£œå……ä¿è²»ã€‚<br>
                        <span class="text-xs text-gray-500">ç³»çµ±è‡ªå‹•ä¾æ“šã€Œæœˆé…/å­£é…ã€é »ç‡è¨ˆç®—å–®æ¬¡é‡‘é¡æ˜¯å¦è¶…æ¨™ã€‚</span>
                    </p>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8 mb-8">
                <!-- Table (Spans 3 cols on large screens) -->
                <div class="xl:col-span-3 overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 border-l-4 border-blue-500 pl-3">ETF å­˜è‚¡æˆæœ¬è©¦ç®—</h3>
                    </div>
                    <!-- Table Container with Horizontal Scroll -->
                    <div class="max-h-[1000px] overflow-y-auto overflow-x-auto custom-scrollbar border rounded-lg shadow-sm">
                        <table class="min-w-full text-sm text-left text-gray-600 relative">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10 shadow-sm font-bold">
                                <tr>
                                    <th class="px-4 py-3 bg-gray-100 sticky left-0 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">ä»£è™Ÿ / åç¨±</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">ä¸Šå¸‚æ—¥</th>
                                    <th class="px-3 py-3 text-center bg-gray-100">é…æ¯æœˆä»½ (é™¤æ¯/é ˜æ¯)</th>
                                    <th class="px-4 py-3 text-right bg-gray-50 text-blue-900 border-l border-gray-200">å³æ™‚è‚¡åƒ¹</th>
                                    <th class="px-4 py-3 text-right bg-gray-50 text-blue-900">é ä¼°æ®–åˆ©ç‡</th>
                                    
                                    <th class="px-4 py-3 text-right bg-blue-50 text-blue-800 border-l border-gray-200">éœ€æ±‚å¼µæ•¸</th>
                                    <th class="px-4 py-3 text-right bg-blue-50 text-blue-800">é ä¼°æˆæœ¬</th>
                                    <th class="px-4 py-3 text-right text-orange-600 bg-gray-100 border-l border-gray-200">äºŒä»£å¥ä¿(å¹´)</th>
                                </tr>
                            </thead>
                            <tbody id="etfTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* è¨»ï¼šæ®–åˆ©ç‡æ¡å¸‚å ´æ¦‚ä¼°å¹³å‡å€¼ã€‚é…æ¯æœˆä»½ç‚ºé ä¼°ï¼Œå¯¦éš›ä¾æŠ•ä¿¡å…¬å‘Šç‚ºæº–ã€‚</p>
                </div>

                <!-- Charts (Sidebar) -->
                <div class="xl:col-span-1 flex flex-col gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’° æ‰€éœ€æœ¬é‡‘ (è¶Šä½è¶Šå¥½)</h3>
                        <div class="relative h-[800px] w-full">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Price Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-900/20 backdrop-blur-[2px] overflow-y-auto h-full w-full flex items-center justify-center z-50 transition-all duration-300">
        <div class="bg-white/30 backdrop-blur-md p-6 rounded-2xl shadow-2xl w-80 relative border border-white/50 ring-1 ring-white/30">
            <button onclick="closeModal('editModal')" class="absolute top-3 right-3 text-gray-700 hover:text-gray-900 transition-colors">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="text-xl font-bold mb-4 text-gray-900 drop-shadow-sm">ä¿®æ”¹è‚¡åƒ¹</h3>
            <div class="mb-5">
                <label class="block text-gray-900 text-sm font-bold mb-2 drop-shadow-sm" id="modalLabel">è¼¸å…¥æ–°è‚¡åƒ¹</label>
                <input type="number" id="newPriceInput" step="0.01" class="shadow-inner appearance-none border border-white/60 rounded-lg w-full py-2 px-3 text-gray-900 font-bold leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500/50 bg-white/50 backdrop-blur-sm placeholder-gray-500">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('editModal')" class="bg-white/40 hover:bg-white/60 text-gray-900 font-medium py-1.5 px-4 rounded-lg transition-all border border-white/60 shadow-sm backdrop-blur-sm">å–æ¶ˆ</button>
                <button onclick="savePrice()" class="bg-blue-600/80 hover:bg-blue-600 text-white font-bold py-1.5 px-4 rounded-lg transition-all shadow-md backdrop-blur-sm border border-blue-400/30">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        // ETF Data with Base Yield Estimation & Schedule
        // Format for schedule: Ex-div month -> Pay month
        let etfData = [
            // --- TOP TIER HIGH YIELD ---
            { code: "00919", name: "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯", date: "2022/10/20", price: 22.15, baseYield: 10.0, freq: "å­£é…", schedule: "é™¤:3,6,9,12 | é ˜:4,7,10,1" },
            { code: "00915", name: "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30", date: "2022/08/09", price: 22.80, baseYield: 9.5, freq: "å­£é…", schedule: "é™¤:3,6,9,12 | é ˜:4,7,10,1" }, 
            { code: "00918", name: "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30", date: "2022/11/24", price: 22.99, baseYield: 9.5, freq: "å­£é…", schedule: "é™¤:3,6,9,12 | é ˜:4,7,10,1" },
            { code: "00929", name: "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯", date: "2023/06/09", price: 18.20, baseYield: 7.5, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" }, 
            
            // --- CLASSIC & STEADY ---
            { code: "0056",  name: "å…ƒå¤§é«˜è‚¡æ¯",      date: "2007/12/26", price: 36.50, baseYield: 8.0, freq: "å­£é…", schedule: "é™¤:1,4,7,10 | é ˜:2,5,8,11" },
            { code: "00713", name: "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢", date: "2017/09/27", price: 51.50, baseYield: 7.0, freq: "å­£é…", schedule: "é™¤:3,6,9,12 | é ˜:4,7,10,1" },
            { code: "00878", name: "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",   date: "2020/07/20", price: 21.50, baseYield: 7.5, freq: "å­£é…", schedule: "é™¤:2,5,8,11 | é ˜:3,6,9,12" },
            
            // --- NEW MONTHLY DIVIDEND WAVE ---
            { code: "00939", name: "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½", date: "2024/03/20", price: 14.10, baseYield: 6.0, freq: "æœˆé…", schedule: "æ¯æœˆ (æœˆåˆé™¤ | æœˆåº•é ˜)" },
            { code: "00940", name: "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯", date: "2024/04/01", price: 9.30, baseYield: 5.5, freq: "æœˆé…", schedule: "æ¯æœˆ (æœˆåˆé™¤ | æœˆåˆé ˜)" },
            { code: "00934", name: "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",   date: "2023/11/01", price: 19.20, baseYield: 7.0, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" },
            { code: "00936", name: "å°æ–°æ°¸çºŒé«˜æ¯ä¸­å°", date: "2023/11/08", price: 16.20, baseYield: 6.0, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" },
            { code: "00944", name: "é‡æ‘è¶¨å‹¢å‹•èƒ½é«˜æ¯", date: "2024/05/09", price: 15.10, baseYield: 6.5, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" },
            { code: "00946", name: "ç¾¤ç›Šç§‘æŠ€é«˜æ¯æˆé•·", date: "2024/05/09", price: 10.50, baseYield: 6.5, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" },
            { code: "00943", name: "å…†è±é›»å­é«˜æ¯ç­‰æ¬Š", date: "2024/05/20", price: 15.00, baseYield: 6.5, freq: "æœˆé…", schedule: "æ¯æœˆé™¤æ¯ | æ¯æœˆé ˜æ¯" },

            // --- SECTOR / SPECIALTY ---
            { code: "00927", name: "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",   date: "2023/06/06", price: 18.50, baseYield: 7.5, freq: "å­£é…", schedule: "é™¤:1,4,7,10 | é ˜:2,5,8,11" },
            { code: "00900", name: "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30", date: "2021/12/22", price: 13.50, baseYield: 7.0, freq: "å­£é…", schedule: "é™¤:2,5,8,11 | é ˜:3,6,9,12" },
            { code: "00932", name: "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š", date: "2023/09/01", price: 16.10, baseYield: 6.0, freq: "å­£é…", schedule: "é™¤:2,5,8,11 | é ˜:3,6,9,12" },
            { code: "00907", name: "æ°¸è±å„ªæ¯å­˜è‚¡",     date: "2022/03/31", price: 15.50, baseYield: 5.5, freq: "é›™æœˆ", schedule: "é™¤:å¶æ•¸æœˆ | é ˜:å¥‡æ•¸æœˆ" },
            { code: "00731", name: "å¾©è¯å¯Œæ™‚é«˜æ¯ä½æ³¢", date: "2018/05/23", price: 72.00, baseYield: 6.0, freq: "å­£é…", schedule: "é™¤:2,5,8,11 | é ˜:3,6,9,12" },
            { code: "00701", name: "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",   date: "2017/08/17", price: 25.40, baseYield: 5.0, freq: "åŠå¹´", schedule: "é™¤:4,10 | é ˜:5,11" },
        ];

        const monthlyInput = document.getElementById('monthlyTarget');
        const targetDisplay = document.getElementById('targetDisplay');
        const tableBody = document.getElementById('etfTableBody');
        const updateTimeDisplay = document.getElementById('updateTimeDisplay');
        const refreshIcon = document.getElementById('refreshIcon');
        const newPriceInput = document.getElementById('newPriceInput');
        let costChart = null;
        let currentEditCode = null;

        // --- Init Logic ---
        function initData() {
            etfData.forEach(etf => {
                etf.dps = etf.price * (etf.baseYield / 100);
            });
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(num);
        }

        // --- REAL STOCK DATA FETCHING ---
        async function fetchRealStockPrices() {
            refreshIcon.classList.add('refresh-spin');
            updateTimeDisplay.textContent = "æ­£åœ¨é€£ç·šè‡³è­‰äº¤æ‰€...";
            
            const stockCodes = etfData.map(etf => `tse_${etf.code}.tw`).join('|');
            const timestamp = new Date().getTime();
            const twseUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${stockCodes}&json=1&delay=0&t=${timestamp}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(twseUrl)}`;

            try {
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(6000) });
                if (!response.ok) throw new Error("Proxy Error");
                
                const data = await response.json();
                
                if (data.msgArray && data.msgArray.length > 0) {
                    let updatedCount = 0;
                    data.msgArray.forEach(item => {
                        const code = item.c;
                        let price = item.z;
                        if (!price || price === '-' || parseFloat(price) === 0) price = item.y;
                        
                        const finalPrice = parseFloat(price);
                        if (!isNaN(finalPrice)) {
                            const targetIndex = etfData.findIndex(e => e.code === code);
                            if (targetIndex !== -1) {
                                etfData[targetIndex].price = finalPrice;
                                updatedCount++;
                            }
                        }
                    });

                    const now = new Date();
                    const timeString = now.toLocaleString('zh-TW', { hour12: false });
                    updateTimeDisplay.textContent = `æœ€å¾Œæ›´æ–°ï¼š${timeString} (TWSE çœŸå¯¦è¡Œæƒ…)`;
                    calculateAndRender();
                    flashRows();
                } 
            } catch (error) {
                console.warn("Real fetch failed", error);
                updateTimeDisplay.textContent = `æ›´æ–°å¤±æ•—ï¼Œç›®å‰é¡¯ç¤ºé è¨­å€¼ (è«‹ç¨å¾Œå†è©¦)`;
            } finally {
                refreshIcon.classList.remove('refresh-spin');
            }
        }

        function flashRows() {
            const rows = document.querySelectorAll('#etfTableBody tr');
            rows.forEach(row => {
                row.classList.remove('price-flash');
                void row.offsetWidth; 
                row.classList.add('price-flash');
            });
        }

        // --- Edit Modal Functions ---
        function openEditModal(code, currentPrice, event) {
            event.stopPropagation();
            currentEditCode = code;
            document.getElementById('modalLabel').textContent = `ä¿®æ”¹ ${code} è‚¡åƒ¹`;
            newPriceInput.value = currentPrice;
            document.getElementById('editModal').classList.remove('hidden');
            setTimeout(() => { newPriceInput.focus(); newPriceInput.select(); }, 50);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function savePrice() {
            const newPrice = parseFloat(newPriceInput.value);
            if (newPrice && newPrice > 0) {
                const index = etfData.findIndex(e => e.code === currentEditCode);
                if (index !== -1) {
                    etfData[index].price = newPrice;
                    calculateAndRender();
                    closeModal('editModal');
                    flashRows();
                }
            }
        }

        newPriceInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') { event.preventDefault(); savePrice(); } 
            else if (event.key === 'Escape') { event.preventDefault(); closeModal('editModal'); }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (!document.getElementById('editModal').classList.contains('hidden')) closeModal('editModal');
            }
        });

        // --- Calculation & Rendering ---
        function calculateAndRender() {
            const monthlyIncome = parseInt(monthlyInput.value);
            const annualIncome = monthlyIncome * 12;
            targetDisplay.textContent = formatCurrency(monthlyIncome);

            tableBody.innerHTML = '';
            
            const labels = [];
            const costs = [];
            const backgroundColors = [];

            const computedData = etfData.map(etf => {
                const currentYield = etf.baseYield;
                const requiredCost = annualIncome / (etf.baseYield / 100);
                const requiredSheets = requiredCost / (etf.price * 1000);
                return { ...etf, currentYield, requiredSheets, requiredCost };
            });

            const sortedData = computedData.sort((a, b) => b.currentYield - a.currentYield);

            sortedData.forEach((etf, index) => {
                let paymentCount = etf.freq === 'æœˆé…' ? 12 : (etf.freq === 'é›™æœˆ' ? 6 : (etf.freq === 'åŠå¹´' ? 2 : 4));
                let singlePaymentAmount = annualIncome / paymentCount;
                let nhiFee = singlePaymentAmount >= 20000 ? annualIncome * 0.0211 : 0;
                
                labels.push(etf.code);
                costs.push(etf.requiredCost);
                if (index < 3) backgroundColors.push('rgba(239, 68, 68, 0.7)'); 
                else backgroundColors.push('rgba(59, 130, 246, 0.5)'); 

                const row = document.createElement('tr');
                row.className = "border-b border-gray-200 transition group hover:bg-gray-50";
                
                let nhiDisplay = nhiFee > 0 
                    ? `<span class="text-orange-600 font-bold text-xs md:text-sm">${formatCurrency(nhiFee)}</span>` 
                    : `<span class="text-gray-300 text-xs md:text-sm">0</span>`;
                
                let freqClass = 'bg-green-100 text-green-800'; 
                if (etf.freq === 'æœˆé…') freqClass = 'bg-purple-100 text-purple-800';
                if (etf.freq === 'é›™æœˆ') freqClass = 'bg-yellow-100 text-yellow-800';
                if (etf.freq === 'åŠå¹´') freqClass = 'bg-gray-200 text-gray-700';
                
                const yieldDisplay = `${etf.currentYield.toFixed(1)}%`;
                const sheetsDisplay = `${etf.requiredSheets.toFixed(1)} å¼µ`;
                const costDisplay = formatCurrency(etf.requiredCost);

                // Add schedule display
                const scheduleHtml = `<div class="text-[10px] text-gray-500 mt-1">${etf.schedule}</div>`;

                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900 sticky left-0 bg-white z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] group-hover:bg-gray-50 transition">
                        <div class="flex flex-col relative">
                            <span class="text-xs text-gray-500">${etf.code}</span>
                            <span class="flex items-center gap-1">${etf.name}</span>
                        </div>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="block text-xs text-gray-500 font-mono">${etf.date}</span>
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs ${freqClass}">
                            ${etf.freq}
                        </span>
                        ${scheduleHtml}
                    </td>
                    <td class="px-4 py-3 text-right font-mono relative bg-gray-50 text-blue-900 font-bold border-l border-gray-200">
                        ${etf.price.toFixed(2)}
                        <button onclick="openEditModal('${etf.code}', ${etf.price}, event)" class="ml-2 text-gray-300 hover:text-blue-500 transition px-1 z-30">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </button>
                    </td>
                    <td class="px-4 py-3 text-right font-mono text-blue-900 font-bold bg-gray-50">${yieldDisplay}</td>
                    
                    <td class="px-4 py-3 text-right font-mono font-bold bg-blue-50 text-blue-800 border-l border-gray-200">${sheetsDisplay}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold text-blue-700 bg-blue-50">${costDisplay}</td>
                    <td class="px-4 py-3 text-right font-mono border-l border-gray-200">${nhiDisplay}</td>
                `;
                tableBody.appendChild(row);
            });

            updateChart(labels, costs, backgroundColors);
        }

        function updateChart(labels, costs, colors) {
            const ctx = document.getElementById('costChart').getContext('2d');
            if (costChart) costChart.destroy();

            costChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ‰€éœ€æœ¬é‡‘ (å…ƒ)',
                        data: costs,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    layout: { padding: { right: 60 } },
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            color: '#4b5563',
                            anchor: 'end',
                            align: 'end',
                            formatter: function(value) {
                                return Math.round(value / 10000) + 'è¬';
                            },
                            font: { weight: 'bold', size: 11 }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { callback: function(value) { return (value / 10000) + 'è¬'; } }
                        }
                    }
                }
            });
        }

        monthlyInput.addEventListener('input', calculateAndRender);
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            calculateAndRender();
            fetchRealStockPrices();
        });

    </script>
</body>
</html>
